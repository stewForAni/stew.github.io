<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>性能工具 | CoolStew</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Traceview &#x2F; Systrace 的基础操作">
<meta property="og:type" content="article">
<meta property="og:title" content="性能工具">
<meta property="og:url" content="https://stewforani.github.io/2022/10/26/Android%20Optimization/%E6%80%A7%E8%83%BD%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="CoolStew">
<meta property="og:description" content="Traceview &#x2F; Systrace 的基础操作">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-10-26T15:02:39.000Z">
<meta property="article:modified_time" content="2023-06-15T13:04:47.969Z">
<meta property="article:author" content="Stew">
<meta property="article:tag" content="Optimization">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="CoolStew" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">CoolStew</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Android Blog &amp; Find Me Github@stewforani</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://stewforani.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Android Optimization/性能工具" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/26/Android%20Optimization/%E6%80%A7%E8%83%BD%E5%B7%A5%E5%85%B7/" class="article-date">
  <time class="dt-published" datetime="2022-10-26T15:02:39.000Z" itemprop="datePublished">2022-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      性能工具
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Traceview &#x2F; Systrace 的基础操作</p>
<span id="more"></span>

<hr>
<h3 id="Traceview"><a href="#Traceview" class="headerlink" title="Traceview"></a>Traceview</h3><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/profile/generate-trace-logs?hl=zh-cn#java">https://developer.android.google.cn/studio/profile/generate-trace-logs?hl=zh-cn#java</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Debug.startMethodTracing(&quot;sample&quot;);</span><br><span class="line">……</span><br><span class="line">Debug.stopMethodTracing();</span><br></pre></td></tr></table></figure>
<p>Device File Explorer中可以找到trace文件，直接打开，可以看到火焰图</p>
<p>Traceview 已弃用。如果您使用的是 Android Studio 3.2 或更高版本，应改为使用 CPU 性能分析器来执行</p>
<ol>
<li>事件时间轴<br>显示应用中的 activity 在其生命周期内不断转换经历各种不同状态的过程，并指示用户与设备的交互，包括屏幕旋转事件。</li>
<li>CPU 时间轴<br>显示应用的实时 CPU 使用率（以占总可用 CPU 时间的百分比表示）以及应用当前使用的线程总数。此时间轴还会显示其他进程（如系统进程或其他应用）的 CPU 使用率，以便您可以将其与您应用的 CPU 使用率进行对比。您可以通过沿时间轴的横轴方向移动鼠标来检查历史 CPU 使用率数据。</li>
<li>线程活动时间轴<br>列出属于应用进程的每个线程，并使用下面列出的颜色在时间轴上指示它们的活动。记录轨迹后，您可以从此时间轴上选择一个线程，以在轨迹窗格中检查其数据。</li>
</ol>
<ul>
<li>绿色：表示线程处于活动状态或准备使用 CPU。也就是说，线程处于正在运行或可运行状态。</li>
<li>黄色：表示线程处于活动状态，但它正在等待一项 I&#x2F;O 操作（如磁盘或网络 I&#x2F;O），然后才能完成它的工作。</li>
<li>灰色：表示线程正在休眠且没有消耗任何 CPU 时间。 当线程需要访问尚不可用的资源时，就会出现这种情况。在这种情况下，要么线程主动进入休眠状态，要么内核将线程置于休眠状态，直到所需的资源可用。</li>
</ul>
<p>TraceView试图收集某个阶段所有函数的运行信息，开销过大</p>
<p>Systrace的思路是反过来的，在不清楚问题的情况下，通过假设－分析－验证 的过程找出问题</p>
<hr>
<h3 id="Systrace"><a href="#Systrace" class="headerlink" title="Systrace"></a>Systrace</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27331842">https://zhuanlan.zhihu.com/p/27331842</a></p>
<ol>
<li>进入systrace目录：<br>cd &#x2F;Users&#x2F;stew&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;platform-tools&#x2F;systrace</li>
<li>执行命令：<br>.&#x2F;systrace.py -t 10 sched gfx view wm am app webview -a <package-name></li>
<li>生成trace.html目录：<br>&#x2F;Users&#x2F;stew&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;platform-tools&#x2F;systrace</li>
<li>在chrome中查看trace.html<br>chrome:&#x2F;&#x2F;tracing&#x2F;trace.html</li>
<li>操作：<br>W : 放大 Systrace , 放大可以更好地看清局部细节<br>S : 缩小 Systrace, 缩小以查看整体<br>A : 左移<br>D : 右移<br>M : 高亮选中当前鼠标点击的段</li>
</ol>
<p>Systrace 是对 Linux Kernel中 ftrace 的封装</p>
<p>内核部分：Systrace 利用了 Linux Kernel 中的 ftrace 功能</p>
<p>数据采集部分：Android 定义了一个 Trace 类。应用程序可利用该类把统计信息输出给ftrace。同时，Android 还有一个 atrace 程序，它可以从 ftrace 中读取统计信息然后交给数据分析工具来处理</p>
<p>数据分析工具：Android 提供一个 systrace.py</p>
<p>线程状态主要有下面几个</p>
<ul>
<li>绿色 : 运行中（Running）<br>只有在该状态的线程才可能在 cpu 上运行</li>
<li>蓝色 : 可运行（Runnable）<br>线程可以运行但当前没有安排，在等待 cpu 调度<br>作用：Runnable 状态的线程状态持续时间越长，则表示 cpu 的调度越忙，没有及时处理到这个任务</li>
<li>白色 : 休眠中（Sleep）<br>线程没有工作要做，可能是因为线程在互斥锁上被阻塞。<br>作用 ： 这里一般是在等事件驱动</li>
<li>橘色 : 不可中断的睡眠态 （Uninterruptible Sleep - IO Block）<br>线程在I &#x2F; O上被阻塞或等待磁盘操作完成</li>
<li>紫色 : 不可中断的睡眠态（Uninterruptible Sleep）<br>一般是陷入了内核态，有些情况下是正常的，有些情况下是不正常的，需要按照具体的情况去分析</li>
</ul>
<p>应用的启动动画由 Launcher 和应用自己的第一帧组成，点击图标启动应用的时候，由于 App 还在启动，Launcher 首先启动一个 StartingWindow，等 App 的第一帧绘制好了之后，再切换到 App 的窗口动画</p>
<p>与 AMS 相关的 Trace 一般会用 TRACE_TAG_ACTIVITY_MANAGER 这个 TAG，在 Systrace 中的名字是 ActivityManager</p>
<p>与 WMS 相关的 Trace 一般会用 TRACE_TAG_WINDOW_MANAGER 这个 TAG，在 Systrace 中 WindowManagerService 在 SystemServer 中多在对应的 Binder 中出现，在 Window 的各种场景一般都会有对应的 Trace 点来记录，比如大家熟悉的 relayoutWIndow、performLayout、prepareToDisplay 等</p>
<p>Input 是 SystemServer 线程里面非常重要的一部分，主要是由 InputReader 和 InputDispatcher 这两个 Native 线程组成</p>
<p>android.bg,BackgroundThread 在系统中使用比较多，许多对性能没有要求的任务，一般都会放到 BackgroundThread 中去执行</p>
<p><code>App 部分 -&gt; BufferQueue 部分 -&gt; SurfaceFlinger 部分 -&gt; HWComposer 部分</code></p>
<ol>
<li><p>App 部分<br>1)Vsync 信号的接收和处理<br>2)RenderThread 的 dequeueBuffer<br>dequeue 有出队的意思，dequeueBuffer 顾名思义，就是从队列中拿出一个 Buffer，这个队列就是 SurfaceFlinger 中的 BufferQueue。<br>3)RenderThread 的 queueBuffer<br>queue 有入队的意思，queueBuffer 顾名思义就是讲 Buffer 放回到 BufferQueue，App 处理完 Buffer 后（写入具体的 drawcall），会把这个 Buffer 通过 eglSwapBuffersWithDamageKHR -&gt; queueBuffer 这个流程，将 Buffer 放回 BufferQueue</p>
</li>
<li><p>BufferQueue 部分<br>dequeue、queue、acquire、release</p>
</li>
<li><p>SurfaceFlinger 部分<br>收到 Vsync 信号后开始工作，MessageQueue::INVALIDATE主要是执行 handleMessageTransaction 和 handleMessageInvalidate 这两个方法，MessageQueue::REFRESH — 主要是执行 handleMessageRefresh 方法</p>
</li>
<li><p>HWComposer 部分<br>1）SurfaceFlinger 向 HWC 提供一个完整的层列表，并询问“您希望如何处理这些层？”<br>2）HWC 的响应方式是将每个层标记为叠加层或 GLES 合成。<br>3）SurfaceFlinger 会处理所有 GLES 合成，将输出缓冲区传送到 HWC，并让 HWC 处理其余部分。</p>
</li>
</ol>
<p><code>Input</code><br>InputReader 和 InputDispatcher 是跑在 SystemServer 里面的两个 Native 线程，负责读取和分发 Input 事件</p>
<p><code>Vsync</code><br>Vsync Offset 我们指的是 VSYNC_APP 和 VSYNC_SF 之间有一个 Offset，即上图中 phase-sf - phase-app 的值，这个 Offset 是厂商可以配置的。如果 Offset 不为 0，那么意味着 App 和 SurfaceFlinger 主进程不是同时收到 Vsync 信号，而是间隔 Offset (通常在 0 - 16.6ms 之间)<br>目前大部分厂商都没有配置这个 Offset，所以 App 和 SurfaceFlinger 是同时收到 Vsync 信号的.</p>
<p>android studio terminal中执行：adb shell dumpsys SurfaceFlinger<br>结果截取：可见offset&#x3D;0<br>           app phase:   1000000 ns               SF phase:   1000000 ns<br>     early app phase:   1000000 ns         early SF phase:   1000000 ns<br>  GL early app phase:   1000000 ns      GL early SF phase:   1000000 ns<br>next VSYNC threshold: 9223372036854775807 ns<br>      present offset:         0 ns           VSYNC period:  16666666 ns</p>
<p>不是每次申请 Vsync 都会由硬件产生 Vsync，只有此次请求 vsync 的时间距离上次合成时间大于 500ms，才会通知 hwc，请求 HW_VSYNC</p>
<p>HW_VSYNC 主要是利用最近的硬件 VSYNC 来做预测,最少要 3 个,最多是 32 个,实际上要用几个则不一定, DispSync 拿到 6 个 VSYNC 后就会计算出 SW_VSYNC,只要收到的 Present Fence 没有超过误差,硬件 VSYNC 就会关掉,不然会继续接收硬件 VSYNC 计算 SW_VSYNC 的值,直到误差小于 threshold.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://stewforani.github.io/2022/10/26/Android%20Optimization/%E6%80%A7%E8%83%BD%E5%B7%A5%E5%85%B7/" data-id="clmqfik3u003ustca65nyfdvd" data-title="性能工具" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Optimization/" rel="tag">Optimization</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/01/20/Android%20Gradle/Gradle%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AE%B0%E5%BD%95/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Gradle知识点记录
        
      </div>
    </a>
  
  
    <a href="/2022/10/25/Android%20Optimization/ASM%E6%8F%92%E6%A1%A9%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8(kotlin)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ASM插桩(kotlin)</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Expansion/" rel="tag">Expansion</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jetpack/" rel="tag">Jetpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Optimization/" rel="tag">Optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/" rel="tag">framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/" rel="tag">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rxjava/" rel="tag">rxjava</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Expansion/" style="font-size: 11.43px;">Expansion</a> <a href="/tags/Java/" style="font-size: 12.86px;">Java</a> <a href="/tags/Jetpack/" style="font-size: 14.29px;">Jetpack</a> <a href="/tags/Optimization/" style="font-size: 15.71px;">Optimization</a> <a href="/tags/algorithm/" style="font-size: 18.57px;">algorithm</a> <a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/framework/" style="font-size: 17.14px;">framework</a> <a href="/tags/gradle/" style="font-size: 11.43px;">gradle</a> <a href="/tags/interview/" style="font-size: 12.86px;">interview</a> <a href="/tags/kotlin/" style="font-size: 11.43px;">kotlin</a> <a href="/tags/rxjava/" style="font-size: 10px;">rxjava</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/05/Android%20Optimization/%E6%8F%92%E4%BB%B6%E5%8C%96%E4%B9%8B%E5%90%AF%E5%8A%A8%E6%9C%AA%E6%B3%A8%E5%86%8CActivity/">插件化之启动未注册Activity</a>
          </li>
        
          <li>
            <a href="/2023/01/23/Android%20Gradle/%E5%8F%91%E5%B8%83Gradle%E6%8F%92%E4%BB%B6(kotlin)/">发布Gradle插件(kotlin)</a>
          </li>
        
          <li>
            <a href="/2023/01/22/Android%20Gradle/%E5%8F%91%E5%B8%83Gradle%E6%8F%92%E4%BB%B6(java)/">发布Gradle插件(java)</a>
          </li>
        
          <li>
            <a href="/2023/01/21/Android%20Optimization/%E7%BB%84%E4%BB%B6%E5%8C%96%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AE%B0%E5%BD%95/">组件化知识点记录</a>
          </li>
        
          <li>
            <a href="/2023/01/20/Android%20Gradle/Gradle%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AE%B0%E5%BD%95/">Gradle知识点记录</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Stew<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>